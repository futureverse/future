<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>A Future for R: Best Practices for Package Developers • future</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A Future for R: Best Practices for Package Developers">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SB3EQSD9FR"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SB3EQSD9FR');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">future</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.69.0-9003</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/future-1-overview.html">A Future for R: A Comprehensive Overview</a></li>
    <li><a class="dropdown-item" href="../articles/future-2-output.html">A Future for R: Text and Message Output</a></li>
    <li><a class="dropdown-item" href="../articles/future-2b-backend.html">A Future for R: Available Future Backends</a></li>
    <li><a class="dropdown-item" href="../articles/future-3-topologies.html">A Future for R: Future Topologies</a></li>
    <li><a class="dropdown-item" href="../articles/future-4-issues.html">A Future for R: Common Issues with Solutions</a></li>
    <li><a class="dropdown-item" href="../articles/future-4-non-exportable-objects.html">A Future for R: Non-Exportable Objects</a></li>
    <li><a class="dropdown-item" href="../articles/future-5-startup.html">A Future for R: Controlling Default Future Strategy</a></li>
    <li><a class="dropdown-item" href="../articles/future-6-future-api-backend-specification.html">A Future for R: Future API Backend Specification</a></li>
    <li><a class="dropdown-item" href="../articles/future-7-for-package-developers.html">A Future for R: Best Practices for Package Developers</a></li>
    <li><a class="dropdown-item" href="../articles/future-8-how-future-is-validated.html">A Future for R: How the Future Framework is Validated</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.futureverse.org/"><span class="fa fas fa-home"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-packages">
<li><a class="external-link dropdown-item" href="https://doFuture.futureverse.org">doFuture (map-reduce)</a></li>
    <li><a class="external-link dropdown-item" href="https://furrr.futureverse.org">furrr (map-reduce)</a></li>
    <li><a class="dropdown-item" href="https://future.futureverse.org">future</a></li>
    <li><a class="external-link dropdown-item" href="https://future.apply.futureverse.org">future.apply (map-reduce)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.batchtools.futureverse.org">future.batchtools (backend)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.callr.futureverse.org">future.callr (backend)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.mirai.futureverse.org">future.mirai (backend)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.tests.futureverse.org">future.tests</a></li>
    <li><a class="external-link dropdown-item" href="https://futurize.futureverse.org">futurize (map-reduce)</a></li>
    <li><a class="external-link dropdown-item" href="https://globals.futureverse.org">globals</a></li>
    <li><a class="external-link dropdown-item" href="https://listenv.futureverse.org">listenv</a></li>
    <li><a class="external-link dropdown-item" href="https://parallelly.futureverse.org">parallelly</a></li>
    <li><a class="external-link dropdown-item" href="https://progressr.futureverse.org">progressr</a></li>
    <li><a class="external-link dropdown-item" href="https://future.p2p.futureverse.org">future.p2p (experimental)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.tools.futureverse.org">future.tools (experimental)</a></li>
    <li><a class="external-link dropdown-item" href="https://marshal.futureverse.org">marshal (experimental)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://cloud.r-project.org/package=future"><span class="fa fab fa-r-project"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/futureverse/future/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>A Future for R: Best Practices for Package Developers</h1>
                        <h4 data-toc-skip class="author">Henrik
Bengtsson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/futureverse/future/blob/HEAD/vignettes/future-7-for-package-developers.md.rsp" class="external-link"><code>vignettes/future-7-for-package-developers.md.rsp</code></a></small>
      <div class="d-none name"><code>future-7-for-package-developers.Rmd</code></div>
    </div>

    
    
<p>Using future code in a package is not much different from other types
of package code or when using futures in R scripts. However, there are a
few things that are useful to know about in order to minimize the risk
for surprises to the end user.</p>
<div class="section level2">
<h2 id="the-future-smell-test">The future smell test<a class="anchor" aria-label="anchor" href="#the-future-smell-test"></a>
</h2>
<p>The by far most common and popular future backend is to parallelize
on the local machine, e.g. <code>plan(multisession)</code>. This is
often good enough in most situations but note that some end-users have
access to multiple machines and might want to run your code using all of
them to speed it up beyond what a single machine can do. Because of
this, avoid as far as possible making assumptions that your code will
only run on the local machine. A good “smell test” is to ask
yourself:</p>
<p><em>- Will my future code work if it ends up running on the other
side of the world?</em></p>
<p>Regardless of performance, if you answer “Yes”, you have already
embraced the core philosophy of the future framework. If you answer
“Maybe” or “No”, see if you can rewrite it.</p>
<p>For instance, if your future code made an assumption that it will
have access to our local file system, as in:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">read_tsv</span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span>  <span class="fu">analyze</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>you can rewrite the code to load the content of the file before you
set up the future, as in:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">read_tsv</span><span class="op">(</span><span class="va">file</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="fu">analyze</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Similarly, we should avoid having the future code write to the local
file system because the parent R session might not have access to that
file system.</p>
<p>By keeping the future smell test in mind when writing future code, we
increase the chances that the code can be parallelized in more ways than
on just the local computer. Properly written future code will work
regardless of what future backend the end-user picks, e.g.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n1.remote.org"</span>, <span class="st">"n2.remote.org"</span>, <span class="st">"n3.remote.org"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">32</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Remember, as developers we never know what compute resources the
end-user has access to right now or they will have access to in six
month. Who knows, your code might even end up running on 2,000 cores
located on The Moon twenty years from now.</p>
</div>
<div class="section level2">
<h2 id="avoid-changing-the-future-backend">Avoid changing the future backend<a class="anchor" aria-label="anchor" href="#avoid-changing-the-future-backend"></a>
</h2>
<p>For reasons like the ones mentioned above, refrain from setting
<code><a href="../reference/plan.html">plan()</a></code> in a function. It is better to leave it to the
end-user to decide how they want to parallelize. One reason for this is
that we can never know how and in what context our code will run. For
example, they might use futures to parallelize a function call in some
other package and that package code calls your package internally. If
you set <code>plan(multisession)</code> internally without undoing, you
might mess up the <code><a href="../reference/plan.html">plan()</a></code> that is already set breaking any
further parallelization.</p>
<p>If you still think it is necessary to set <code><a href="../reference/plan.html">plan()</a></code>, make
sure to undo it when the function exits, also on errors. This can be
done by using <code>with(plan(...), local = TRUE)</code>, e.g.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_fcn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>, local <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">analyze</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The need for setting the future backend within a function often comes
from developers wanting to add an argument to their function that allows
the end-user to specify whether they want to run the function in
parallel or sequentially. This often result in code like:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_fcn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">parallel</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">parallel</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span>, local <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">x</span>, FUN <span class="op">=</span> <span class="va">analyze</span><span class="op">)</span> <span class="co">## from future.apply package</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">x</span>, FUN <span class="op">=</span> <span class="va">analyze</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This way the user can use:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">my_fcn</span><span class="op">(</span><span class="va">x</span>, parallel <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>or</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">my_fcn</span><span class="op">(</span><span class="va">x</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>depending on their needs. However, if another package developer
decides to call your function in their function, they now have to expose
that <code>parallel</code> argument to the users of their function,
e.g.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">their_fcn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">parallel</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu">preprocess</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">my_fcn</span><span class="op">(</span><span class="va">x2</span>, parallel <span class="op">=</span> <span class="va">parallel</span><span class="op">)</span></span>
<span>  <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu">another_fcn</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>  <span class="va">z</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Exposing and passing a “parallel” argument along can become quite
cumbersome. Instead, it is neater to use:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_fcn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://future.apply.futureverse.org/reference/future_lapply.html" class="external-link">future_lapply</a></span><span class="op">(</span><span class="va">x</span>, FUN <span class="op">=</span> <span class="va">analyze</span><span class="op">)</span> <span class="co">## from future.apply package</span></span>
<span>  <span class="fu">summarize</span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>and let the user control whether or not they want to parallelize via
<code><a href="../reference/plan.html">plan()</a></code>, e.g. <code>plan(multisession)</code> and
<code>plan(sequential)</code>.</p>
</div>
<div class="section level2">
<h2 id="avoid-changing-the-future-options">Avoid changing the future options<a class="anchor" aria-label="anchor" href="#avoid-changing-the-future-options"></a>
</h2>
<p>Just like for other R options, you must not change any of the R
<code>future.*</code> options. Only the end-user should set these.</p>
<p>If you find yourself having to tweak one of the options, make sure to
undo your changes immediately afterward. For example, if you want to
bump up the <code>future.globals.maxSize</code> limit when creating a
future, use something like the following inside your function:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">oopts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>future.globals.maxSize <span class="op">=</span> <span class="fl">1.0</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span>  <span class="co">## 1.0 GB</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">oopts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/future.html">future</a></span><span class="op">(</span><span class="op">{</span> <span class="va">expr</span> <span class="op">}</span><span class="op">)</span>  <span class="co">## Launch a future with large objects</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="writing-examples">Writing examples<a class="anchor" aria-label="anchor" href="#writing-examples"></a>
</h2>
<p>If your example sets the future backend at the beginning, make sure
to reset the future backend to <code>plan(sequential)</code> at the end
of the example. The reason for this is that when switching plan, the
previous one will be cleaned up. This is particularly important for
multisession and cluster futures where <code>plan(sequential)</code>
will shut down the underlying PSOCK clusters.</p>
<p>For instance, here is an example:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Run the analysis in parallel on the local computer</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"multisession"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">analyze</span><span class="op">(</span><span class="st">"path/to/file.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Shut down parallel workers</span></span>
<span><span class="fu">future</span><span class="fu">::</span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="st">"sequential"</span><span class="op">)</span></span></code></pre></div>
<p>If you forget to shut down the PSOCK cluster, then
<code>R CMD check --as-cran</code>, or <code>R CMD check</code> with
environment variable <code>_R_CHECK_CONNECTIONS_LEFT_OPEN_=true</code>
set, will produce an error on</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="sc">$</span> R CMD check <span class="sc">--</span>as<span class="sc">-</span>cran mypkg_1.<span class="fl">0.</span>tar.gz</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>...</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="sc">*</span> checking examples ... ERROR</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>Running examples <span class="cf">in</span> <span class="st">'analyze-Ex.R'</span> failed</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>...</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">cleanEx</span>()</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>Error<span class="sc">:</span> connections left open<span class="sc">:</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>      <span class="er">&lt;</span><span class="sc">-</span>localhost<span class="sc">:</span><span class="dv">37400</span> (sockconn)</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>      <span class="ot">&lt;-</span>localhost<span class="sc">:</span><span class="dv">37400</span> (sockconn)</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>Execution halted</span></code></pre></div>
<p>If you for some reason do not like to display reset of the future
backend in the help documentation, but you still want it run, wrap the
statement in an Rd <code>\dontshow{}</code> statement.</p>
</div>
<div class="section level2">
<h2 id="writing-vignettes">Writing vignettes<a class="anchor" aria-label="anchor" href="#writing-vignettes"></a>
</h2>
<p>Importantly, if you use the <code>multisession</code> backend in a
vignette, you must manually specify the number of workers, i.e.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The reason for having to manually limit the number workers in
vignettes, while it is automatically limited for us in package examples
and package tests, is that <code>R CMD check --as-cran</code> does
<em>not</em> set environment variable <code>_R_CHECK_LIMIT_CORES_</code>
when re-building vignettes, resulting in the default
<code>workers = availableCores()</code> to use whatever number of cores
that the operating system has given our R process.</p>
<p>Don’t forget to stop the parallel workers by calling</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>at the end of you vignette.</p>
</div>
<div class="section level2">
<h2 id="testing-a-package-that-relies-on-futures">Testing a package that relies on futures<a class="anchor" aria-label="anchor" href="#testing-a-package-that-relies-on-futures"></a>
</h2>
<p>If you want to make sure your code works when running sequentially as
well as when running in parallel, it is often good enough to have
package tests that run the code with:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span><span class="op">)</span></span></code></pre></div>
<p>If the code works with this setup, you can be sure that all global
variables are properly identified and exported to the workers and that
the required packages are loaded on the workers.</p>
<p>Always make sure to shut down your parallel ‘multisession’ workers at
the end of each package test by calling:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>If not all of your tests are written this way, you can set
environment variable <code>R_FUTURE_PLAN=multisession</code> before you
call <code>R CMD check</code>. This will make the default future backend
to become ‘multisession’ instead of ‘sequential’. For example,</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="ex">$</span> export R_FUTURE_PLAN=multisession</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="ex">$</span> R CMD check <span class="at">--as-cran</span> mypkg_1.0.tar.gz</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="making-sure-to-stop-parallel-workers">Making sure to stop parallel workers<a class="anchor" aria-label="anchor" href="#making-sure-to-stop-parallel-workers"></a>
</h2>
<p>When creating a <code>cluster</code> object, for instance via
<code>plan(multisession)</code>, in a package help example, in a package
vignette, or in a package test, we must _remember to stop the cluster at
the end of all examples(*), vignettes, and unit tests_. This is required
in order to not leave behind stray parallel <code>cluster</code> workers
after our main R session terminates. On Linux and macOS, the operating
system often takes care of terminating the worker processes if we
forget, but on MS Windows such processes will keep running in the
background until they time out themselves, which takes 30 days
(sic!).</p>
<p><code>R CMD check --as-cran</code> will indirectly detect these stray
worker processes on MS Windows when running R (&gt;= 4.3.0). They are
detected, because they result in placeholder
<code>Rscript&lt;hexcode&gt;</code> files being left behind in the
temporary directory. The check NOTE to look out for (only in R (&gt;=
4.3.0)) is:</p>
<pre><code>* checking for detritus in the temp directory ... NOTE
Found the following files/directories:
  'Rscript1058267d0c10' 'Rscriptbd4267d0c10'</code></pre>
<p>Those <code>Rscript&lt;hexcode&gt;</code> files are from background R
worker processes, which almost always are parallel
<code>cluster</code>:s that we forgot to stop at the end. To stop
‘multisession’ workers, call:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
<p>at the end of your examples(*), vignettes, and package tests.</p>
<p>If you create the <code>cluster</code> manually using</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/makeClusterPSOCK.html" class="external-link">makeClusterPSOCK</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>make sure to stop such clusters at the end using</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span>
<span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span></code></pre></div>
<p>(*) Currently, examples are excluded from the detritus checks. This
was validated with R-devel revision 82991 (2022-10-02).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Henrik Bengtsson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0</p> and <a href="https://github.com/HenrikBengtsson/pkgdown.extras/">pkgdown.extras</a> 0.0.0.9007.</p>
</div>

    </footer>
</div>





  </body>
</html>
