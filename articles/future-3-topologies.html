<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>A Future for R: Future Topologies • future</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="A Future for R: Future Topologies">
<!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SB3EQSD9FR"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SB3EQSD9FR');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">future</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.69.0-9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/future-1-overview.html">A Future for R: A Comprehensive Overview</a></li>
    <li><a class="dropdown-item" href="../articles/future-2-output.html">A Future for R: Text and Message Output</a></li>
    <li><a class="dropdown-item" href="../articles/future-2b-backend.html">A Future for R: Available Future Backends</a></li>
    <li><a class="dropdown-item" href="../articles/future-3-topologies.html">A Future for R: Future Topologies</a></li>
    <li><a class="dropdown-item" href="../articles/future-4-issues.html">A Future for R: Common Issues with Solutions</a></li>
    <li><a class="dropdown-item" href="../articles/future-4-non-exportable-objects.html">A Future for R: Non-Exportable Objects</a></li>
    <li><a class="dropdown-item" href="../articles/future-5-startup.html">A Future for R: Controlling Default Future Strategy</a></li>
    <li><a class="dropdown-item" href="../articles/future-6-future-api-backend-specification.html">A Future for R: Future API Backend Specification</a></li>
    <li><a class="dropdown-item" href="../articles/future-7-for-package-developers.html">A Future for R: Best Practices for Package Developers</a></li>
    <li><a class="dropdown-item" href="../articles/future-8-how-future-is-validated.html">A Future for R: How the Future Framework is Validated</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.futureverse.org/"><span class="fa fas fa-home"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-packages" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Packages</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-packages">
<li><a class="external-link dropdown-item" href="https://doFuture.futureverse.org">doFuture (map-reduce)</a></li>
    <li><a class="external-link dropdown-item" href="https://furrr.futureverse.org">furrr (map-reduce)</a></li>
    <li><a class="dropdown-item" href="https://future.futureverse.org">future</a></li>
    <li><a class="external-link dropdown-item" href="https://future.apply.futureverse.org">future.apply (map-reduce)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.batchtools.futureverse.org">future.batchtools (backend)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.callr.futureverse.org">future.callr (backend)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.mirai.futureverse.org">future.mirai (backend)</a></li>
    <li><a class="external-link dropdown-item" href="https://future.tests.futureverse.org">future.tests</a></li>
    <li><a class="external-link dropdown-item" href="https://futurize.futureverse.org">futurize (map-reduce)</a></li>
    <li><a class="external-link dropdown-item" href="https://globals.futureverse.org">globals</a></li>
    <li><a class="external-link dropdown-item" href="https://listenv.futureverse.org">listenv</a></li>
    <li><a class="external-link dropdown-item" href="https://parallelly.futureverse.org">parallelly</a></li>
    <li><a class="external-link dropdown-item" href="https://progressr.futureverse.org">progressr</a></li>
    <li><a class="external-link dropdown-item" href="https://future.tools.futureverse.org">future.tools (experimental)</a></li>
    <li><a class="external-link dropdown-item" href="https://marshal.futureverse.org">marshal (experimental)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="external-link nav-link" href="https://cloud.r-project.org/package=future"><span class="fa fab fa-r-project"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/futureverse/future/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>A Future for R: Future Topologies</h1>
                        <h4 data-toc-skip class="author">Henrik
Bengtsson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/futureverse/future/blob/HEAD/vignettes/future-3-topologies.md.rsp" class="external-link"><code>vignettes/future-3-topologies.md.rsp</code></a></small>
      <div class="d-none name"><code>future-3-topologies.Rmd</code></div>
    </div>

    
    
<p>Futures can be nested in R such that one future creates another set
of futures and so on. This may, for instance, occur within nested for
loops, e.g.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://listenv.futureverse.org" class="external-link">listenv</a></span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://listenv.futureverse.org/reference/listenv.html" class="external-link">listenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ii</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span><span class="op">[[</span><span class="va">ii</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="op">{</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://listenv.futureverse.org/reference/listenv.html" class="external-link">listenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">y</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="op">{</span> <span class="va">ii</span> <span class="op">+</span> <span class="va">jj</span> <span class="op">/</span> <span class="fl">10</span> <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">y</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">## [1] 1.1 1.2 1.3 2.1 2.2 2.3 3.1 3.2 3.3</span></span></code></pre></div>
<p>The default is to use synchronous futures unless otherwise specified,
which is also true for nested futures. If we for instance specify,
<code>plan(multisession)</code>, the first layer of futures
(<code>x[[ii]] %&lt;-% { expr }</code>) will be processed asynchronously
in background R processes, and the futures in the second layer of
futures (<code>y[[jj]] %&lt;-% { expr }</code>) will be processed
synchronously in the separate background R processes. If we wish to be
explicit about this, we can specify
<code>plan(list(multisession, sequential))</code>.</p>
<div class="section level2">
<h2 id="example-high-throughput-sequencing">Example: High-Throughput Sequencing<a class="anchor" aria-label="anchor" href="#example-high-throughput-sequencing"></a>
</h2>
<p>Consider a high-throughput sequencing (HT-Seq) project with 50 human
DNA samples where we have one FASTQ file per sample containing the raw
sequence reads as they come out of the sequencing machine. With this
data, we wish to align each FASTQ to a reference genome such that we
generate 24 individual BAM files per sample - one per chromosome.</p>
<p>Here is the layout of what such an analysis could look like in R
using futures.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://listenv.futureverse.org" class="external-link">listenv</a></span><span class="op">)</span></span>
<span><span class="va">htseq_align</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fq</span>, <span class="va">chr</span><span class="op">)</span> <span class="op">{</span> <span class="va">chr</span> <span class="op">}</span></span>
<span></span>
<span><span class="va">fqs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"[.]fastq$"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://listenv.futureverse.org/reference/listenv.html" class="external-link">listenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">ss</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">fqs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fq</span> <span class="op">&lt;-</span> <span class="va">fqs</span><span class="op">[</span><span class="va">ss</span><span class="op">]</span></span>
<span>  <span class="va">bams</span><span class="op">[[</span><span class="va">ss</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="op">{</span></span>
<span>    <span class="va">bams_ss</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://listenv.futureverse.org/reference/listenv.html" class="external-link">listenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">cc</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">24</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">bams_ss</span><span class="op">[[</span><span class="va">cc</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="fu">htseq_align</span><span class="op">(</span><span class="va">fq</span>, chr <span class="op">=</span> <span class="va">cc</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">bams_ss</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">bams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">bams</span><span class="op">)</span></span></code></pre></div>
<p>The default is to use synchronous futures, so without further
specifications, the above will process each sample and each chromosome
sequentially. Next, we will consider what can be done with the following
two computer setups:</p>
<ul>
<li>A single machine with 8 cores</li>
<li>A compute cluster with 3 machines each with 16 cores</li>
</ul>
<div class="section level3">
<h3 id="one-multi-core-machine">One multi-core machine<a class="anchor" aria-label="anchor" href="#one-multi-core-machine"></a>
</h3>
<p>With a single machine of 8 cores, we could choose to process multiple
samples at the same time while processing chromosomes sequentially. In
other words, we would like to evaluate the outer layer of futures using
multisession futures and the inner ones as sequential futures. This can
be specified as:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">multisession</span>, <span class="va">sequential</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The internals for processing multisession future queries
<code><a href="../reference/re-exports.html">availableCores()</a></code> to infer how many cores can be used
simultaneously, so there is no need to explicitly specify that there are
8 cores available.</p>
<p><em>Comment</em>: Since synchronous is the default future, we could
skip trailing sequential futures in the setup,
e.g. <code>plan(list(multisession))</code> or just
<code>plan(multisession)</code>. However, it does not hurt to be
explicit.</p>
<p>If we instead would like to process the sample sequentially and the
chromosomes in parallel, we can use:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sequential</span>, <span class="va">multisession</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="built-in-protection-against-recursive-parallelism">Built-in protection against recursive parallelism<a class="anchor" aria-label="anchor" href="#built-in-protection-against-recursive-parallelism"></a>
</h4>
<p>Above we have processed either the outer or the inner set of future
in parallel. What if we want to process both layers in parallel? It’s
tempting to use:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">multisession</span>, <span class="va">multisession</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Although this does not give an error, we will find that the inner
layer of futures will be processed sequentially just as if we would use
<code>plan(list(multisession, sequential))</code>. This behavior is due
to the built-in protection against nested parallelism. If both layers
would run in parallel, each using the 8 cores available on the machine,
we would be running 8 * 8 = 64 parallel processes - that would for sure
overload our computer. What happens internally is that for the outer
layer, <code><a href="../reference/re-exports.html">availableCores()</a></code> equals eight (8), whereas for the
inner layer it equals one (1).</p>
<p>Now, we could imagine that we process the outer layer with, say, two
parallel futures, and then the inner layer with four parallel futures.
In that case, we would end up running on at most eight cores (= 2 * 4).
This can be achieved by forcing a fixed number of workers at each
layer:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Note that As-Is <code>I(.)</code> specification for the inner layer,
i.e. <code>workers = I(4)</code>. If we would just specify
<code>workers = 4</code>, the future framework would detect this as a
potential user mistake. This is because by default it prevents nested
parallelization and allots only a single CPU core to the inner layer,
i.e. <code><a href="../reference/re-exports.html">availableCores()</a></code> will return one there. However, the
user requests four CPU cores, which could result in an unintended 400%
CPU overuse. The future framework detects this discrepancy, and if it is
too large, it will produce an error. For example, on an eight core
machine, we would get the following error produced at the inner
layer:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="op">&gt;</span> plan<span class="kw">(</span><span class="ex">list</span><span class="er">(</span><span class="ex">tweak</span><span class="er">(</span><span class="ex">multisession,</span> workers = 2<span class="kw">)</span><span class="ex">,</span> tweak<span class="er">(</span><span class="ex">multisession,</span> workers = 4<span class="kw">)))</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="op">&gt;</span> a <span class="ex">%</span><span class="op">&lt;</span>-% { b %<span class="op">&lt;</span>-% 1 <span class="kw">;</span> <span class="ex">b</span> }</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="op">&gt;</span> a</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="ex">Error</span> in checkNumberOfLocalWorkers<span class="er">(</span><span class="ex">workers</span><span class="kw">)</span> <span class="bu">:</span> </span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="ex">Attempting</span> to set up 4 localhost parallel workers with only 1 CPU</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="ex">cores</span> available for this R process <span class="er">(</span><span class="ex">per</span> <span class="st">'mc.cores'</span><span class="kw">)</span><span class="ex">,</span> which could</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="ex">result</span> in a 400% load. The hard limit is set to 300%. Overusing the</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="ex">CPUs</span> has negative impact on the current R process, but also on all</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="ex">other</span> processes of yours and others running on the same machine. See</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="bu">help</span><span class="er">(</span><span class="st">"parallelly.maxWorkers.localhost"</span><span class="ex">,</span> package = <span class="st">"parallelly"</span><span class="kw">)</span> <span class="cf">for</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="ex">further</span> explanations and how to override the hard limit that triggered</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="ex">this</span> error</span></code></pre></div>
<p>Because Futureverse has this built-in protection, we need to
explicitly override it by declaring nested workers using the As-Is
<code>I(.)</code> function. This basically tells the parallel framework
“trust us, we know what we are doing”. To minimize the risk of mistakes
here, please make sure your settings respect what
<code><a href="../reference/re-exports.html">availableCores()</a></code> gives.</p>
<p>To make sure we stay within the limits of the current machine, it’s
best to use something like:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="../reference/re-exports.html">availableCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span> <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>However, before using nested parallelization on a single machine,
make sure it is actually more efficient than using parallelization in
only one of the layers.</p>
</div>
</div>
<div class="section level3">
<h3 id="an-ad-hoc-compute-cluster">An ad-hoc compute cluster<a class="anchor" aria-label="anchor" href="#an-ad-hoc-compute-cluster"></a>
</h3>
<p>With a compute cluster of 3 machines each with 16 cores, we can run
up to 48 alignment processes in parallel. A natural setup is to have one
machine process one sample in parallel. We could specify this as:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n1"</span>, <span class="st">"n2"</span>, <span class="st">"n3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span>, <span class="va">multisession</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><em>Comment:</em> Multisession futures are agile to its environment,
that is, they will query the machine they are running on to find out how
many parallel processes it can run at the same time.</p>
<p>One possible downside to the above setup is that we might not utilize
all available cores all the time. This is because the alignment of the
shorter chromosomes will finish sooner than the longer ones, which means
that we might at the end of each sample have only a few alignment
processes running on each machine leaving the remaining cores
idle/unused. An alternative set up is then to use the following
setup:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n1"</span>, <span class="st">"n2"</span>, <span class="st">"n3"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This will cause up to 24 (= 3*8) samples to be processed in parallel
each processing two chromosomes at the same time.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-a-remote-compute-cluster">Example: A Remote Compute Cluster<a class="anchor" aria-label="anchor" href="#example-a-remote-compute-cluster"></a>
</h2>
<p>Imagine we have access to a remote compute cluster, with login node
<code>remote.server.org</code>, and that the cluster has three nodes
<code>n1</code>, <code>n2</code>, and <code>n3</code>. Also, let us
assume we have already set up the cluster such that we can log in via
public key authentication via SSH, i.e. when we do
<code>ssh remote.server.org</code> authentication is done
automatically.</p>
<p>With the above setup, we can use nested futures in our local R
session to evaluate R expression on the remote compute cluster and its
three nodes. Here is a proof of concept illustrating how the different
nested futures are evaluated on different machines.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://listenv.futureverse.org" class="external-link">listenv</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set up access to remote login node (must have Rscript)</span></span>
<span><span class="va">login</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="st">"remote.server.org"</span>, persistent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="va">login</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Set up cluster nodes on login node</span></span>
<span><span class="va">nodes</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="op">{</span> <span class="va">.keepme</span> <span class="op">&lt;-</span> <span class="fu">parallelly</span><span class="fu">::</span><span class="fu"><a href="https://parallelly.futureverse.org/reference/makeClusterPSOCK.html" class="external-link">makeClusterPSOCK</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n1"</span>, <span class="st">"n2"</span>, <span class="st">"n3"</span><span class="op">)</span><span class="op">)</span> <span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">nodes</span><span class="op">)</span></span>
<span><span class="co">## socket cluster with 3 nodes on hosts 'n1', 'n2', 'n3'</span></span>
<span></span>
<span><span class="co">## Specify future topology</span></span>
<span><span class="co">## login node -&gt; { cluster nodes } -&gt; { multiple cores }</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="va">login</span>,</span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span>,</span>
<span>  <span class="va">multisession</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## (a) This will be evaluated on the cluster login computer</span></span>
<span><span class="va">x</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="op">{</span></span>
<span>  <span class="va">thost</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"nodename"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">tpid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://listenv.futureverse.org/reference/listenv.html" class="external-link">listenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">task</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## (b) This will be evaluated on a compute node on the cluster</span></span>
<span>    <span class="va">y</span><span class="op">[[</span><span class="va">task</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="op">{</span></span>
<span>      <span class="va">mhost</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"nodename"</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="va">mpid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://listenv.futureverse.org/reference/listenv.html" class="external-link">listenv</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">jj</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co">## (c) These will be evaluated in separate processes on the same compute node</span></span>
<span>        <span class="va">z</span><span class="op">[[</span><span class="va">jj</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/futureAssign.html">%&lt;-%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>task <span class="op">=</span> <span class="va">task</span>,</span>
<span>                                top.host <span class="op">=</span> <span class="va">thost</span>, top.pid <span class="op">=</span> <span class="va">tpid</span>,</span>
<span>                                mid.host <span class="op">=</span> <span class="va">mhost</span>, mid.pid <span class="op">=</span> <span class="va">mpid</span>,</span>
<span>                                host <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"nodename"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>                                pid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">z</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">y</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">##   task top.host top.pid mid.host mid.pid host    pid</span></span>
<span><span class="co">## 1    1    login  391547       n1  391878   n1 393943</span></span>
<span><span class="co">## 2    1    login  391547       n1  391878   n1 393951</span></span>
<span><span class="co">## 3    2    login  391547       n2  392204   n2 393971</span></span>
<span><span class="co">## 4    2    login  391547       n2  392204   n2 393978</span></span>
<span><span class="co">## 5    3    login  391547       n3  392527   n3 394040</span></span>
<span><span class="co">## 6    3    login  391547       n3  392527   n3 394048</span></span>
<span><span class="co">## 7    4    login  391547       n1  391878   n1 393959</span></span>
<span><span class="co">## 8    4    login  391547       n1  391878   n1 393966</span></span></code></pre></div>
<p>Try the above <code>x %&lt;-% { ... }</code> future with, say,
<code>plan(list(sequential, multisession))</code> and see what the
output will be.</p>
</div>
<div class="section level2">
<h2 id="example-adjust-the-number-of-workers-for-each-cluster-node">Example: Adjust the Number of Workers for Each Cluster Node<a class="anchor" aria-label="anchor" href="#example-adjust-the-number-of-workers-for-each-cluster-node"></a>
</h2>
<p>When using</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nodes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n1"</span>, <span class="st">"n2"</span>, <span class="st">"n3"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span>, <span class="va">multisession</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>the number of workers used on each of the nodes (<code>n1</code>,
<code>n2</code>, and <code>n3</code>) is given by the value of
<code><a href="../reference/re-exports.html">availableCores()</a></code> on each of those nodes. In turn,
<code><a href="../reference/re-exports.html">availableCores()</a></code> typically defaults to the number of cores
on those nodes. Now, imagine you want to use only 50% of these cores.
This can be done by tweaking the <code>multisession</code> plan by
passing a function to <code>workers</code>;</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>halfCores <span class="ot">&lt;-</span> <span class="cf">function</span>() { <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">round</span>(<span class="fl">0.5</span> <span class="sc">*</span> <span class="fu">availableCores</span>()))</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">plan</span>(<span class="fu">list</span>(</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="fu">tweak</span>(cluster, <span class="at">workers =</span> nodes),</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="fu">tweak</span>(multisession, <span class="at">workers =</span> <span class="fu">I</span>(halfCores))</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>))</span></code></pre></div>
<p>With this, each node will use at most 50% of the cores available. For
instance, if <code>n1</code> and <code>n2</code> have eight cores, and
<code>n3</code> has 32 cores, then the nodes will use four, four, and 16
cores, respectively.</p>
<p>Another example is:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">customWorkers</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.info.html" class="external-link">Sys.info</a></span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="st">"nodename"</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="st">"n1"</span> <span class="op">=</span> <span class="fl">2L</span>,</span>
<span>    <span class="st">"n2"</span> <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>    <span class="co">## default:</span></span>
<span>    <span class="fu"><a href="../reference/re-exports.html">availableCores</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="../reference/plan.html">plan</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">cluster</span>, workers <span class="op">=</span> <span class="va">nodes</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/plan.html">tweak</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">customWorkers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In this case, node <code>n1</code> will always use two cores,
<code>n2</code> three cores, and <code>n3</code> will respect what
<code><a href="../reference/re-exports.html">availableCores()</a></code> returns.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Henrik Bengtsson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0</p> and <a href="https://github.com/HenrikBengtsson/pkgdown.extras/">pkgdown.extras</a> 0.0.0.9007.</p>
</div>

    </footer>
</div>





  </body>
</html>
